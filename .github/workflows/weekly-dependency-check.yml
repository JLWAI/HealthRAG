name: Weekly Dependency Check

# Run every Monday at 2 AM UTC
on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  dependency-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit pipdeptree
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          pip list --outdated --format=columns || echo "No outdated packages" >> $GITHUB_STEP_SUMMARY
          pip list --outdated --format=json > outdated.json
          OUTDATED_COUNT=$(jq length outdated.json)
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          cat outdated.json >> $GITHUB_STEP_SUMMARY

      - name: Run security audit
        id: audit
        continue-on-error: true
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          pip-audit --desc --format json > audit.json || true

          # Check if audit found vulnerabilities
          if [ -s audit.json ]; then
            VULN_COUNT=$(jq '.vulnerabilities | length' audit.json 2>/dev/null || echo "0")
            echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT

            # Add to summary
            jq -r '.vulnerabilities[] | "- **\(.name)** v\(.installed_version): \(.id) (\(.severity))"' audit.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Error parsing vulnerabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "vulnerability_count=0" >> $GITHUB_OUTPUT
            echo "âœ… No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check dependency tree
        run: |
          echo "## Dependency Tree" >> $GITHUB_STEP_SUMMARY
          pipdeptree --warn silence >> $GITHUB_STEP_SUMMARY

      - name: Create issue if updates needed
        if: steps.outdated.outputs.outdated_count > 0 || steps.audit.outputs.vulnerability_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8'));
            const audit = fs.existsSync('audit.json') ? JSON.parse(fs.readFileSync('audit.json', 'utf8')) : { vulnerabilities: [] };

            const today = new Date().toISOString().split('T')[0];
            const weekNumber = Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / 604800000);

            let body = `## ðŸ“¦ Weekly Dependency Update - Week ${weekNumber}\n\n`;
            body += `**Generated:** ${today}\n`;
            body += `**Outdated Packages:** ${outdated.length}\n`;
            body += `**Security Vulnerabilities:** ${audit.vulnerabilities?.length || 0}\n\n`;

            body += `---\n\n`;

            if (audit.vulnerabilities && audit.vulnerabilities.length > 0) {
              body += `## ðŸ”’ Security Vulnerabilities (URGENT)\n\n`;
              audit.vulnerabilities.forEach(vuln => {
                body += `### ${vuln.name} v${vuln.installed_version}\n`;
                body += `- **CVE:** ${vuln.id}\n`;
                body += `- **Severity:** ${vuln.severity}\n`;
                body += `- **Fix:** Upgrade to v${vuln.fixed_version || 'See advisory'}\n`;
                body += `- **Advisory:** ${vuln.advisory_url || 'N/A'}\n\n`;
              });
            }

            if (outdated.length > 0) {
              body += `## ðŸ“¦ Outdated Packages\n\n`;
              body += `| Package | Current | Latest | Type |\n`;
              body += `|---------|---------|--------|------|\n`;
              outdated.forEach(pkg => {
                body += `| ${pkg.name} | ${pkg.version} | ${pkg.latest_version} | ${pkg.latest_filetype} |\n`;
              });
              body += `\n`;
            }

            body += `---\n\n`;
            body += `## ðŸ“‹ Action Required\n\n`;
            body += `Please follow the [Weekly Dependency Update Template](.github/ISSUE_TEMPLATE/weekly-dependency-update.md) to:\n\n`;
            body += `1. Review all updates above\n`;
            body += `2. Test updates in development branch\n`;
            body += `3. Update requirements files\n`;
            body += `4. Run full test suite\n`;
            body += `5. Update documentation if needed\n\n`;

            body += `**Priority:** ${audit.vulnerabilities?.length > 0 ? 'ðŸ”´ HIGH (Security vulnerabilities)' : 'ðŸŸ¡ MEDIUM (Routine update)'}\n\n`;
            body += `**Estimated Time:** 2-4 hours\n\n`;

            body += `---\n\n`;
            body += `<details>\n<summary>ðŸ“Š Full Audit Report</summary>\n\n`;
            body += `\`\`\`json\n${JSON.stringify(audit, null, 2)}\n\`\`\`\n\n`;
            body += `</details>\n\n`;
            body += `<details>\n<summary>ðŸ“¦ Full Outdated Report</summary>\n\n`;
            body += `\`\`\`json\n${JSON.stringify(outdated, null, 2)}\n\`\`\`\n\n`;
            body += `</details>\n`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[DEPS] Weekly Dependency Update - Week ${weekNumber} (${today})`,
              body: body,
              labels: ['dependencies', 'maintenance', audit.vulnerabilities?.length > 0 ? 'security' : 'enhancement']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-reports
          path: |
            outdated.json
            audit.json
          retention-days: 30

  notify:
    needs: dependency-check
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Notify on failure
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[ALERT] Weekly Dependency Check Failed',
              body: `The weekly dependency check workflow failed. Please investigate:\n\n` +
                    `**Run:** ${context.runId}\n` +
                    `**Workflow:** ${context.workflow}\n` +
                    `**URL:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'dependencies', 'ci/cd']
            });
